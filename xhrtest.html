<html>
<body>
<form>
	<input type="radio" name="op" value="d">Delete<br>
	<input type="radio" name="op" value="i">Insert<br>
	<input type="text" id="cont" name="content">
	<input type="number" name="position" id="pos" min="0" max="100">
</form>
<button id="apply" onclick="apply();"> Apply </button>
<button id="send" onclick="newOp();"> Send </button>

<p id="display"></p>

<script src="xforml.js"></script>
<script>
var buffer = [];
var revisionNr = 0;
var arr = ["test"];
function buildOp() {
	var radios = document.getElementsByName("op");
	var operation;
	for (var i = 0; i < radios.length; i++) {       
		if (radios[i].checked) {
			operation = radios[i].value;
			break;
		}
	}
	
	var opToSend = {
		o:operation,
		k:document.getElementById("pos").value,
		c:document.getElementById("cont").value
	};
	console.log(opToSend);
	return opToSend;
}

function apply() {
	var opToSend = buildOp();
	buffer.push(opToSend);
	executeOp(opToSend); //execute operation locally
}

function transform(op) {
	for (var i = 0; i < buffer.length; i++){
		xformed = xforml(op, buffer[i]);
		op = xformed [0];
		buffer[i] = xformed[1];
	}
	
	return op
}


function newOp() {
	var opToSend = buffer.shift();
	opToSend["rn"] = revisionNr;
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function () {
		if (xhr.readyState == 4 && xhr.status == 200) {
			console.log(xhr.response);
		}
	};
	xhr.open("POST", "newOp", true);
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send(JSON.stringify(opToSend)); //send operation to server
}

function wait() {
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function () {
		if (xhr.readyState == 4 && xhr.status == 200) {
			recieved = JSON.parse(xhr.response);
			revisionNr++;
			if (recieved["o"] != "a"){
				recieved = transform(recieved);
				executeOp(recieved);
			}
			wait();
		}
	}
	xhr.ontimeout = function () {
		wait();
	}
	xhr.open("POST", "wait", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send("waiting");

	
}

function executeOp(op) {
	console.log(op)
	if (op.o == "i") {arr.splice(op["k"], 0, op["c"]);}
	if (op.o == "d") {arr.splice(op["k"], 1);}
	document.getElementById("display").innerHTML = arr.toString();
}

document.getElementById("display").innerHTML = arr.toString();
wait();
</script>
</body>
</html>
